<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head>
    <title>STACK!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.0/p5.js">
    </script>

    <script>
        var boxes = []
        var colors = []
        var down = 125
        var pressed = true
        var rX = 100.3
        var rY = 1
        var gameover = false
        var minSpeed = 5
        var maxSpeed = 13
        var r // initial random red
        var g // inital random green
        var b // inital random blue

        function setup() {
            createCanvas(600, 900, WEBGL)
            setAttributes('antialias', true); // use AA to help soften jagged edges/aliasing
            randColor()
            r = colors[1]
            g = colors[1]
            b = colors[1]

            /* using orthographic projection to make all boxes appear to have the same size
               left, right, bottom, top, near, far */
            ortho(-width / 2, width / 2, -height / 2, height / 2.5, -height * 2, height * 4);

        }

        function draw() {
            // -width/2,-height/2 -------- width/2,-height/2
            //                |            |
            //                |     0,0    |
            //                |            |
            // -width/2,height/2--------width/2,height/2

            background(0)
            down = constrain(down, -315 + boxes.length * 20, 395) // prevent boxes from exceeding or lower than canvas height
            translate(0, down, 100)
            rotateX(rX)
            rotateY(rY)
            fill(r, g, b)
            stroke(0)
            strokeWeight(2.35)
            box(150, 20, 150) // inital box

            for (var i = 0; i < boxes.length; i++) {
                boxes[i].move()
                boxes[i].display()
            }

            if (gameover == true) {
                boxes.splice(0, boxes.length) // remove all boxes from array
                minSpeed = 5 // reset speed to default
                maxSpeed = 13
                down = 125 // reset location of boxes
                gameover = false // restart game by allowing new boxes to be pushed
            }

            // object rotations/translations
            if (keyIsPressed) {
                if (keyCode == 37) rY += 0.1 // left arrow rotates boxes counter clockwise
                if (keyCode == 39) rY -= 0.1 // right arrow rotates boxes clockwise
                if (keyCode == 38) down-- // up arrow move boxes up
                    if (keyCode == 40) down++ // down arrow moves boxes down
            }
            if (keyCode == 46) rY = 183 // del to reset rotation to default
        }

        function randColor() {
            for (var i = 0; i < 2; i++) {
                var newColor = color(random(255), random(255), random(255))
                colors.push(newColor);
            }
        }

        function keyPressed() {
            if (pressed && !gameover) {
                if (keyCode == 13) {
                    minSpeed += 0.5 // gradually increase the boundaries of random speed
                    maxSpeed += 0.5
                    boxes.push(new Box())
                    colors.splice(0, colors.length)
                    randColor()
                    pressed = !pressed // set to false to prevent multiple executions
                }
            }

            // prevent multiple boxes being pushed per key press
            if (keyCode == 16) pressed = true
        }

        function Box() {
            this.x = -620
            this.xSpeed = Math.ceil(random(minSpeed, maxSpeed))
            this.y = -20
            this.z = 0
            this.r = colors[0] // each new box follows the same color scheme
            this.b = colors[0]
            this.g = colors[0]
            this.w = round(random(35, 100))
            this.placed = true

            this.move = function() {
                this.x += this.xSpeed

                // if block is not placed
                if (keyCode != 16 && this.x > width * 2) this.x = -620 // place the box back to the beginning 

                /* this part of code makes no sense, as the current width of the box * 2 
                   doesn't check location for the previous box
                   so therefore sometimes the box places on top of nothing with widths < ~50 */
                if (keyCode == 16 && (this.x + this.w < 0)) gameover = true //if user places box before stack
                else if (keyCode == 16 && (this.x + this.w > this.w * 2)) gameover = true // if user places box past stack 

                // place box when SHIFT is pressed
                if (keyCode == 16) {
                    if (this.placed == true) {
                        this.xSpeed = 0
                        this.r = colors[1] // alternate between the different colors in array
                        this.g = colors[1]
                        this.b = colors[1]
                        down += 12 // move all blocks down by increments of 12 pixels each time user places box
                        this.placed = false // set back to false to prevent multiple executions of the same code
                    }
                }
            }

            this.display = function() {
                fill(this.r, this.g, this.b)
                translate(this.x, this.y, this.z)
                box(this.w, 20, 150)
            }
        }
    </script>
</head>

<body>
    <form><input TYPE="button" onClick="history.go(0)" value="Reset"></form>
    <div id="code" class="container-fluid">
        <script src="https://gist-it.appspot.com/github/alexy4744/p5js/blob/master/STACK!.html?footer=0"></script>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script>
        $(window).bind("load", function() {
            $('#code').before($('#defaultCanvas0').remove());
        });
    </script>
</body>

</html>
